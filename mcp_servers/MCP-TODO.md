# MCP 模块代码审核 TODO

> 审核时间: 2025-12-26
> 审核人: 游资风格量化分析
> 综合评分: 35/100
> 状态: 当前代码仅可用于演示，不可用于实盘

---

## 一、严重问题（必须修复）

### 1. 连板判断完全错误
- **文件**: `lib/data/market_data.py:198-212`
- **问题**:
  - [ ] 连板池逻辑错误：`board_count >= 2` 不等于真正的连板
  - [ ] 漏掉"今日断板"的情况
  - [ ] 东财API的 `days` 字段不可靠，需要回溯K线验证
- **影响**: 误判"二进三"，漏掉断板股
- **修复方案**:
  ```python
  # 需要实现：回溯历史K线验证连板
  def verify_continuous_board(code: str, date: str) -> int:
      """验证真实连板天数，需回溯K线"""
      pass
  ```

### 2. 龙头判断过于单薄
- **文件**: `lib/indicators/position.py:93-108`
- **问题**:
  - [ ] 只按首封时间排序判断龙头，完全错误
  - [ ] 缺少辨识度评估
  - [ ] 缺少封单质量评估
  - [ ] 缺少溢价能力评估
  - [ ] 缺少容量匹配评估
- **影响**: 垃圾股被判为龙一，真龙头被判为杂毛
- **修复方案**:
  ```python
  # 龙头评分模型（需实现）
  def calculate_dragon_score(stock) -> float:
      score = 0
      score += recognition_score(stock) * 0.3      # 辨识度
      score += seal_quality_score(stock) * 0.25    # 封单质量
      score += premium_ability_score(stock) * 0.25 # 溢价能力
      score += capacity_match_score(stock) * 0.2   # 容量匹配
      return score
  ```

### 3. 弱转强信号判断有漏洞
- **文件**: `lib/strategies/signal_strategy.py:84-122`
- **问题**:
  - [ ] 只筛选炸板股，漏掉烂板、断板、首阴、大面修复
  - [ ] 竞价高开不等于弱转强确认
  - [ ] 缺少开盘5分钟确认逻辑
  - [ ] 缺少分时均线站稳判断
- **影响**: 假信号多，真信号漏
- **修复方案**:
  ```python
  # 弱转强候选来源（需扩展）
  WEAK_TO_STRONG_SOURCES = [
      "炸板股",      # open_count > 0
      "烂板股",      # 首封时间 > 14:30
      "断板股",      # 昨日连板今日未封
      "首阴股",      # 连板股首次收阴
      "大面修复",    # 昨日跌>7%今日高开
  ]

  # 确认逻辑（需实现）
  def confirm_weak_to_strong(code: str) -> bool:
      """9:30-9:35 确认逻辑"""
      pass
  ```

### 4. 核按钮定义错误
- **文件**: `lib/indicators/sentiment.py:198`
- **问题**:
  - [ ] 阈值错误：使用 `-5%` 而非正确的跌停阈值
  - [ ] 未区分主板和创业板/科创板
- **影响**: 大量正常低开被误判为核按钮
- **修复方案**:
  ```python
  # 正确的核按钮阈值
  def is_nuclear_button(code: str, open_pct: float) -> bool:
      if code.startswith(("30", "68")):  # 创业板/科创板
          return open_pct < -18
      else:  # 主板
          return open_pct < -9
  ```

---

## 二、中等问题（需要改进）

### 5. 赚钱效应计算过于简单
- **文件**: `lib/indicators/sentiment.py:138-150`
- **问题**:
  - [ ] 只算开盘溢价，缺少盘中/收盘溢价
  - [ ] 未区分首板溢价和连板溢价
  - [ ] 未剔除一字板（无参与价值）
- **修复方案**:
  ```python
  # 真实赚钱效应算法
  real_profit_effect = (
      first_board_premium * 0.3 +
      continuous_board_premium * 0.7
  ) * (1 - yizi_ratio)
  ```

### 6. 逻辑硬度评分太主观
- **文件**: `lib/indicators/logic.py:36-53`
- **问题**:
  - [ ] 评分表是静态的，未考虑市场风格轮动
  - [ ] `_infer_theme_info()` 是纯关键词匹配
  - [ ] 题材新旧天数是硬编码
- **修复方案**:
  - [ ] 接入真实题材数据源
  - [ ] 根据市场资金流向动态调整权重
  - [ ] 追踪题材首次出现时间

### 7. 容量龙扫描缺少关键过滤
- **文件**: `lib/indicators/capacity.py:157-212`
- **问题**:
  - [ ] 未过滤权重股（银行、保险等）
  - [ ] 未过滤量化收割场
  - [ ] 身位判断过于粗暴
- **修复方案**:
  ```python
  # 需要添加的过滤器
  EXCLUDE_INDUSTRIES = ["银行", "保险", "石油", "电力"]
  QUANT_SEATS = ["华鑫上海", "东财拉萨", ...]

  def filter_capacity_dragons(stocks):
      # 1. 排除权重股
      # 2. 排除量化主导票
      # 3. 重新计算身位
      pass
  ```

### 8. 跷跷板效应监控不完整
- **文件**: `lib/monitors/see_saw_monitor.py`
- **问题**:
  - [ ] 只监控3分钟涨跌幅，缺少分时细节
  - [ ] 时间精度不够（需秒级）
  - [ ] `_yesterday_leaders` 需手动设置，无自动识别
- **修复方案**:
  - [ ] 接入秒级行情数据
  - [ ] 实现分时重合度计算
  - [ ] 自动识别昨日龙头和今日候选

---

## 三、轻微问题（建议改进）

### 9. 炸板率计算缺少时间维度
- **文件**: `lib/indicators/sentiment.py:440-455`
- **问题**:
  - [ ] 未区分早盘炸板和尾盘炸板
- **修复方案**:
  ```python
  # 加权炸板率
  weighted_explosion_rate = (
      morning_explosion * 1.5 +  # 早盘炸板权重更高
      afternoon_explosion * 1.0
  ) / total
  ```

### 10. 宏观总闸数据全是模拟数据
- **文件**: `lib/monitors/macro_kill_switch.py:106-110`
- **问题**:
  - [ ] 返回硬编码数据，功能形同虚设
- **修复方案**:
  - [ ] 接入离岸人民币实时数据
  - [ ] 接入A50期货数据
  - [ ] 接入北向资金实时数据（东财/同花顺）

### 11. 竞价信号阈值不区分板块
- **文件**: `lib/strategies/signal_strategy.py:319`
- **问题**:
  - [ ] 一字板阈值 9.5% 不区分主板/创业板
- **修复方案**:
  ```python
  def is_yizi_board(code: str, open_pct: float) -> bool:
      if code.startswith(("30", "68")):
          return open_pct >= 19.5
      else:
          return open_pct >= 9.5
  ```

---

## 四、数据源问题

### 12. 东财API数据可靠性
- **文件**: `lib/data/market_data.py`
- **问题**:
  - [ ] 数据延迟1-3秒
  - [ ] 盘中数据不稳定
  - [ ] 无数据校验机制
  - [ ] 无备用数据源
- **修复方案**:
  - [ ] 接入 akshare 作为备用
  - [ ] 接入 tushare 做交叉验证
  - [ ] 添加数据完整性检查
  - [ ] 添加重试机制

---

## 五、修复优先级

| 优先级 | 问题 | 预计工作量 |
|--------|------|------------|
| P0 | 核按钮阈值错误 | 0.5天 |
| P0 | 连板判断错误 | 2天 |
| P0 | 龙头识别重写 | 3天 |
| P1 | 弱转强信号完善 | 2天 |
| P1 | 赚钱效应算法优化 | 1天 |
| P1 | 竞价阈值区分板块 | 0.5天 |
| P2 | 逻辑硬度动态化 | 3天 |
| P2 | 容量龙过滤器 | 1天 |
| P2 | 跷跷板监控完善 | 2天 |
| P3 | 宏观数据接入 | 2天 |
| P3 | 多数据源接入 | 3天 |

---

## 六、测试检查清单

完成修复后，需要通过以下测试：

- [ ] 连板判断：用历史数据回测，准确率 > 95%
- [ ] 龙头识别：与人工判断对比，一致率 > 80%
- [ ] 核按钮识别：无误判（误判会导致错过行情）
- [ ] 弱转强信号：回测胜率 > 60%
- [ ] 赚钱效应：与市场实际表现相关性 > 0.7
- [ ] 数据可靠性：连续运行24小时无异常

---

## 七、备注

1. **当前状态**: 代码仅可用于演示和学习
2. **实盘风险**: 直接用于实盘大概率亏钱
3. **建议**: 先完成 P0 级别问题修复，再逐步完善其他功能
4. **数据源**: 建议优先接入 akshare（免费）或 tushare（需积分）

---

*最后更新: 2025-12-26*
